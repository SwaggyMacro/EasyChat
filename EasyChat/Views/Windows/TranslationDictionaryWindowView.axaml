<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:suki="https://github.com/kikipoulet/SukiUI"
        xmlns:icons="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
        xmlns:lang="using:EasyChat.Lang"
        xmlns:vm="using:EasyChat.ViewModels.Windows"
        xmlns:models="using:EasyChat.Models"
        xmlns:selection="clr-namespace:EasyChat.Models.Translation.Selection"
        xmlns:controls="clr-namespace:EasyChat.Controls"
        mc:Ignorable="d" d:DesignWidth="450" d:DesignHeight="400"
        x:Class="EasyChat.Views.Windows.TranslationDictionaryWindowView"
        x:DataType="vm:TranslationDictionaryWindowViewModel"
        x:Name="TranslationWindow"
        Width="450" MinHeight="250" MaxHeight="600"
        SystemDecorations="None"
        Background="Transparent"
        Topmost="True"
        ShowInTaskbar="False"
        CornerRadius="12"
        CanResize="True"
        Focusable="False"
        ShowActivated="False"
        WindowStartupLocation="Manual"
        SizeToContent="Height">

    <Window.Styles>
        <!-- Style for interactive word tokens -->
        <Style Selector="Button.WordToken">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0,0,1,2"/>
            <Setter Property="CornerRadius" Value="2"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            
            <!-- Keep background transparent on hover -->
            <Style Selector="^:pointerover /template/ ContentPresenter">
                <Setter Property="Background" Value="Transparent"/>
            </Style>

            <!-- Non-word tokens -->
            <Style Selector="^.NonWord">
                 <Setter Property="Cursor" Value="Arrow"/>
                 <Setter Property="IsEnabled" Value="False"/> 
                 <Style Selector="^ /template/ ContentPresenter">
                     <Setter Property="Background" Value="Transparent"/>
                     <Setter Property="Foreground" Value="{DynamicResource SukiText}"/>
                 </Style>
            </Style>
        </Style>

        <!-- Animated Underline Base Style -->
        <Style Selector="Border.AnimatedUnderline">
            <Setter Property="Background" Value="{DynamicResource SukiPrimaryColor}"/>
            <Setter Property="Height" Value="3"/> <!-- Thicker as requested -->
            <Setter Property="VerticalAlignment" Value="Bottom"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="RenderTransform" Value="scaleX(0)"/>
            <Setter Property="RenderTransformOrigin" Value="0%,50%"/> <!-- Left Anchor -->
            <Setter Property="Transitions">
                <Transitions>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.25" Easing="CircularEaseOut"/>
                </Transitions>
            </Setter>
        </Style>

        <!-- Animated Underline Trigger -->
        <!-- Important: Target the Border inside the Button when Button is hovered -->
        <Style Selector="Button.WordToken:pointerover Border.AnimatedUnderline">
            <Setter Property="RenderTransform" Value="scaleX(1)"/>
        </Style>
    </Window.Styles>

    <Panel Margin="5">
        <suki:GlassCard Padding="0" CornerRadius="12">
            <Grid RowDefinitions="Auto,*,Auto">
                
                <!-- Header -->
                <Border Grid.Row="0" Background="{DynamicResource SukiCardBackground}" 
                        CornerRadius="12,12,0,0" Padding="16,12"
                        PointerPressed="OnHeaderPointerPressed">
                    <Grid ColumnDefinitions="*,Auto">
                        <!-- Dynamic Title -->
                        <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                            <!-- Back Button (Word Mode) -->
                            <Button IsVisible="{Binding ShowBackButton}" 
                                    Command="{Binding SwitchToSentenceModeCommand}"
                                    Classes="Flat" Padding="4" Width="28" Height="28">
                                <icons:MaterialIcon Kind="ArrowLeft" Width="18" Height="18" Foreground="White"/>
                            </Button>

                            <StackPanel Orientation="Vertical" VerticalAlignment="Center">
                                <TextBlock Text="{Binding DictionaryResult.Word, FallbackValue='Translation'}" 
                                           IsVisible="{Binding IsWordMode}"
                                           FontWeight="Bold" FontSize="18" Foreground="{DynamicResource SukiText}"/>
                                <StackPanel Orientation="Horizontal" Spacing="8" IsVisible="{Binding IsWordMode}">
                                    <TextBlock Text="{Binding DictionaryResult.Phonetic}" 
                                               FontSize="13" Foreground="{DynamicResource SukiLowText}" VerticalAlignment="Center"/>
                                    <Button Classes="Flat" Padding="2" Width="20" Height="20" IsVisible="{Binding DictionaryResult.Phonetic, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                         <icons:MaterialIcon Kind="VolumeHigh" Width="14" Height="14" Foreground="White"/>
                                    </Button>
                                </StackPanel>
                                
                            </StackPanel>
                        </StackPanel>
                        
                    </Grid>
                </Border>
                
                <!-- Main Content -->
                <Panel Grid.Row="1">
                    <Border Background="{DynamicResource SukiCardBackground}">
                        <ScrollViewer MaxHeight="400">
                    <Panel>
                        <!-- Loading State Removed from inside Panel -->

                        <!-- Dictionary View (Word Mode) -->
                        <StackPanel Margin="16,8" IsVisible="{Binding IsWordMode}" Spacing="16">
                             
                             <!-- Tips -->
                             <Border Background="#1AFFFF00" CornerRadius="8" Padding="12" 
                                     IsVisible="{Binding DictionaryResult.Tips, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                 <StackPanel Spacing="4">
                                     <StackPanel Orientation="Horizontal" Spacing="6">
                                         <icons:MaterialIcon Kind="LightbulbOutline" Width="16" Height="16" Foreground="#E6E600"/>
                                         <TextBlock Text="{x:Static lang:Resources.Tips}" FontWeight="Bold" FontSize="12" Foreground="#E6E600"/>
                                     </StackPanel>
                                     <TextBlock Text="{Binding DictionaryResult.Tips}" TextWrapping="Wrap" FontSize="13" Foreground="{DynamicResource SukiText}"/>
                                 </StackPanel>
                             </Border>

                             <ItemsControl ItemsSource="{Binding DictionaryResult.Parts}">
                                 <ItemsControl.ItemTemplate>
                                     <DataTemplate DataType="selection:DictionaryPart">
                                         <StackPanel Margin="0,0,0,12">
                                             <TextBlock Text="{Binding PartOfSpeech}" 
                                                        FontWeight="Bold" FontStyle="Italic" Foreground="{DynamicResource SukiPrimaryColor}"
                                                        Margin="0,0,0,4"/>
                                             <ItemsControl ItemsSource="{Binding Definitions}">
                                                 <ItemsControl.ItemTemplate>
                                                     <DataTemplate>
                                                         <Grid ColumnDefinitions="Auto, *" Margin="4,2,0,4">
                                                             <Border Width="4" Height="4" Background="{DynamicResource SukiText}" CornerRadius="2" Margin="0,8,8,0" VerticalAlignment="Top" Opacity="0.6"/>
                                                             <TextBlock Grid.Column="1" Text="{Binding}" TextWrapping="Wrap"
                                                                    FontSize="14" Foreground="{DynamicResource SukiText}"/>
                                                         </Grid>
                                                     </DataTemplate>
                                                 </ItemsControl.ItemTemplate>
                                             </ItemsControl>
                                         </StackPanel>
                                     </DataTemplate>
                                 </ItemsControl.ItemTemplate>
                             </ItemsControl>

                             <!-- Examples -->
                             <StackPanel IsVisible="{Binding DictionaryResult.Examples.Count}">
                                 <Border Background="{DynamicResource SukiControlBorderBrush}" Height="1" Margin="0,0,0,12"/>
                                 <TextBlock Text="{x:Static lang:Resources.Examples}" FontWeight="Bold" Margin="0,0,0,8" Foreground="{DynamicResource SukiText}"/>
                                 <ItemsControl ItemsSource="{Binding DictionaryResult.Examples}">
                                     <ItemsControl.ItemTemplate>
                                         <DataTemplate DataType="selection:DictionaryExample">
                                             <StackPanel Margin="0,0,0,12">
                                                 <TextBlock Text="{Binding Origin}" TextWrapping="Wrap" FontSize="14" Foreground="{DynamicResource SukiText}"/>
                                                 <TextBlock Text="{Binding Translation}" TextWrapping="Wrap" FontSize="13" Foreground="{DynamicResource SukiLowText}" Margin="0,2,0,0"/>
                                             </StackPanel>
                                         </DataTemplate>
                                     </ItemsControl.ItemTemplate>
                                 </ItemsControl>
                             </StackPanel>
                        </StackPanel>

                        <!-- Sentence View (Transition Mode) -->
                        <Border IsVisible="{Binding !IsWordMode}" Padding="16, 0, 12,12">
                            <StackPanel Spacing="16">
                                <!-- Interactive Source Text -->
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal" Spacing="6" Margin="0,0,0,8">
                                            <icons:MaterialIcon Kind="TextShort" Width="16" Height="16" Foreground="{DynamicResource SukiPrimaryColor}"/>
                                            <TextBlock Text="{x:Static lang:Resources.SelectionTranslate_SourceLabel}" FontWeight="SemiBold" FontSize="13" Foreground="{DynamicResource SukiText}"/>
                                        </StackPanel>
                                    
                                        <controls:VirtualizedTokenDisplay 
                                            Tokens="{Binding SourceTokens}"
                                            WordClickedCommand="{Binding LookupWordCommand}"
                                            FontSize="15"
                                            LineHeight="24"
                                            Foreground="{DynamicResource SukiText}"
                                            NonWordForeground="Gray"
                                            FontWeight="Bold"
                                            UnderlineColor="{DynamicResource SukiPrimaryColor}"/>
                                    </StackPanel>

                                <Separator Background="{DynamicResource SukiControlBorderBrush}" Height="1"/>

                                <!-- Translation Result -->
                                <Grid RowDefinitions="Auto,*">
                                    <StackPanel Orientation="Horizontal" Spacing="6" Margin="0,0,0,8">
                                        <icons:MaterialIcon Kind="Translate" Width="16" Height="16" Foreground="{DynamicResource SukiPrimaryColor}"/>
                                        <TextBlock Text="{x:Static lang:Resources.SelectionTranslate_ResultLabel}" FontWeight="SemiBold" FontSize="13" Foreground="{DynamicResource SukiText}"/>
                                    </StackPanel>
                                    <TextBlock x:Name="ResultTextBlock" Grid.Row="1" 
                                               Text="{Binding TranslationResult}" 
                                               TextWrapping="Wrap" FontSize="15" LineHeight="24"
                                               Foreground="{DynamicResource SukiText}"/>
                                </Grid>
                            </StackPanel>
                        </Border>
                    </Panel>
                    </ScrollViewer>
                    </Border>
                    
                    <!-- Loading Overlay -->
                    <Border IsVisible="{Binding IsLoading}" Background="#80000000" IsHitTestVisible="True">
                        <suki:Loading Width="45" Height="45" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                </Panel>

                <!-- Footer Actions -->
                <Border Grid.Row="2" Background="{DynamicResource SukiCardBackground}" 
                        CornerRadius="0,0,12,12" Padding="12,8" BorderBrush="{DynamicResource SukiControlBorderBrush}" BorderThickness="0,1,0,0">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                         <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                             <Border Background="{DynamicResource SukiControlBorderBrush}" CornerRadius="4" Padding="6,2">
                                 <TextBlock Text="{Binding SourceLanguageDisplay}" FontSize="11" Foreground="{DynamicResource SukiText}"/>
                             </Border>
                             <icons:MaterialIcon Kind="ArrowRight" Width="14" Height="14" Foreground="{DynamicResource SukiText}"/>
                             <Border Background="{DynamicResource SukiControlBorderBrush}" CornerRadius="4" Padding="6,2">
                                 <TextBlock Text="{Binding TargetLanguageDisplay}" FontSize="11" Foreground="{DynamicResource SukiText}"/>
                             </Border>
                         </StackPanel>

                        <!-- Removed History and Like buttons as requested -->
                        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                            <Button Click="OnCopyClick" ToolTip.Tip="{x:Static lang:Resources.SelectionTranslate_CopyTooltip}" 
                                    Classes="Flat" Padding="6" Width="32" Height="32">
                                <icons:MaterialIcon Kind="ContentCopy" Width="18" Height="18" Foreground="White"/>
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>
        </suki:GlassCard>
    </Panel>
</Window>
