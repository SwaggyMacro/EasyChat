<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:suki="https://github.com/kikipoulet/SukiUI"
        xmlns:icons="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
        xmlns:lang="using:EasyChat.Lang"
        xmlns:vm="using:EasyChat.ViewModels.Windows"
        xmlns:models="using:EasyChat.Models"
        xmlns:selection="clr-namespace:EasyChat.Models.Translation.Selection"
        xmlns:controls="clr-namespace:EasyChat.Controls"
        mc:Ignorable="d" d:DesignWidth="450" d:DesignHeight="400"
        x:Class="EasyChat.Views.Windows.SelectionTranslateWindowView"
        x:DataType="vm:SelectionTranslateWindowViewModel"
        x:Name="SelectionWindow"
        Width="450" MinHeight="250" MaxHeight="600"
        SystemDecorations="None"
        Background="Transparent"
        Topmost="True"
        ShowInTaskbar="False"
        CornerRadius="12"
        CanResize="True"
        ShowActivated="False"
        WindowStartupLocation="Manual"
        SizeToContent="Height">

    <Window.Styles>
        <!-- Style for interactive word tokens -->
        <Style Selector="Button.WordToken">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0,0,1,2"/>
            <Setter Property="CornerRadius" Value="2"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            
            <!-- Keep background transparent on hover -->
            <Style Selector="^:pointerover /template/ ContentPresenter">
                <Setter Property="Background" Value="Transparent"/>
            </Style>

            <!-- Non-word tokens -->
            <Style Selector="^.NonWord">
                 <Setter Property="Cursor" Value="Arrow"/>
                 <Setter Property="IsEnabled" Value="False"/> 
                 <Style Selector="^ /template/ ContentPresenter">
                     <Setter Property="Background" Value="Transparent"/>
                     <Setter Property="Foreground" Value="{DynamicResource SukiText}"/>
                 </Style>
            </Style>
        </Style>

        <!-- Animated Underline Base Style -->
        <Style Selector="Border.AnimatedUnderline">
            <Setter Property="Background" Value="{DynamicResource SukiPrimaryColor}"/>
            <Setter Property="Height" Value="3"/> <!-- Thicker as requested -->
            <Setter Property="VerticalAlignment" Value="Bottom"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="RenderTransform" Value="scaleX(0)"/>
            <Setter Property="RenderTransformOrigin" Value="0%,50%"/> <!-- Left Anchor -->
            <Setter Property="Transitions">
                <Transitions>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.25" Easing="CircularEaseOut"/>
                </Transitions>
            </Setter>
        </Style>

        <!-- Animated Underline Trigger -->
        <!-- Important: Target the Border inside the Button when Button is hovered -->
        <Style Selector="Button.WordToken:pointerover Border.AnimatedUnderline">
            <Setter Property="RenderTransform" Value="scaleX(1)"/>
        </Style>
    </Window.Styles>

    <Panel Margin="5">
        <suki:GlassCard Padding="0" CornerRadius="12">
            <Grid RowDefinitions="Auto,*,Auto">
                
                <!-- Header -->
                <Border Grid.Row="0" Background="{DynamicResource SukiCardBackground}" 
                        CornerRadius="12,12,0,0" Padding="16,12"
                        PointerPressed="OnHeaderPointerPressed">
                    <Grid ColumnDefinitions="*,Auto">
                        <!-- Dynamic Title -->
                        <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                            <!-- Back Button (Word Mode) -->
                            <Button IsVisible="{Binding ShowBackButton}" 
                                    Command="{Binding SwitchToSentenceModeCommand}"
                                    Classes="Flat" Padding="4" Width="28" Height="28">
                                <icons:MaterialIcon Kind="ArrowLeft" Width="18" Height="18" Foreground="{DynamicResource SukiText}"/>
                            </Button>

                            <StackPanel Orientation="Vertical" VerticalAlignment="Center">
                                <TextBlock Text="{Binding DictionaryResult.Word, FallbackValue='Translation'}" 
                                           IsVisible="{Binding IsWordMode}"
                                           FontWeight="Bold" FontSize="18" Foreground="{DynamicResource SukiText}"/>
                                <StackPanel Orientation="Horizontal" Spacing="8" IsVisible="{Binding IsWordMode}">
                                    <Border Background="{DynamicResource SukiControlBorderBrush}" CornerRadius="4" Padding="4,0" IsVisible="{Binding DictionaryResult.Phonetic, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                        <TextBlock Text="US" FontSize="10" FontWeight="Bold" Foreground="{DynamicResource SukiLowText}"/>
                                    </Border>
                                    <TextBlock Text="{Binding DictionaryResult.Phonetic}" 
                                               FontSize="13" Foreground="{DynamicResource SukiLowText}" VerticalAlignment="Center"/>
                                    <Button Classes="Flat" Padding="2" Width="20" Height="20" IsVisible="{Binding DictionaryResult.Phonetic, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                         <icons:MaterialIcon Kind="VolumeHigh" Width="14" Height="14" Foreground="{DynamicResource SukiText}"/>
                                    </Button>
                                </StackPanel>
                                
                            </StackPanel>
                        </StackPanel>
                        
                    </Grid>
                </Border>
                
                <!-- Main Content -->
                <ScrollViewer Grid.Row="1" MaxHeight="400" Background="{DynamicResource SukiCardBackground}">
                    <Panel>
                        <!-- Loading State -->
                        <StackPanel IsVisible="{Binding IsLoading}" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="20">
                            <suki:Loading Width="30" Height="30"/>
                        </StackPanel>

                        <!-- Dictionary View (Word Mode) -->
                        <ItemsControl ItemsSource="{Binding DictionaryResult.Parts}" Margin="16,8" IsVisible="{Binding IsWordMode}">
                             <ItemsControl.ItemTemplate>
                                 <DataTemplate DataType="selection:DictionaryPart">
                                     <Grid RowDefinitions="Auto,*" ColumnDefinitions="40,*" Margin="0,8">
                                         <TextBlock Grid.Column="0" Text="{Binding PartOfSpeech}" 
                                                    FontWeight="Bold" Foreground="{DynamicResource SukiPrimaryColor}"
                                                    VerticalAlignment="Top" Margin="0,2,0,0"/>
                                         <ItemsControl Grid.Column="1" ItemsSource="{Binding Definitions}">
                                             <ItemsControl.ItemTemplate>
                                                 <DataTemplate>
                                                     <TextBlock Text="{Binding}" TextWrapping="Wrap" Margin="0,0,0,4"
                                                                FontSize="14" Foreground="{DynamicResource SukiText}"/>
                                                 </DataTemplate>
                                             </ItemsControl.ItemTemplate>
                                         </ItemsControl>
                                     </Grid>
                                 </DataTemplate>
                             </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Sentence View (Transition Mode) -->
                        <Border IsVisible="{Binding !IsWordMode}" Padding="16, 0, 12,12">
                            <StackPanel Spacing="16">
                                <!-- Interactive Source Text -->
                                <Border CornerRadius="8" Background="{DynamicResource SukiBackground}" Padding="12, 8, 12, 12">
                                    <controls:VirtualizedTokenDisplay 
                                        Tokens="{Binding SourceTokens}"
                                        WordClickedCommand="{Binding LookupWordCommand}"
                                        FontSize="15"
                                        LineHeight="24"
                                        Foreground="{DynamicResource SukiText}"
                                        NonWordForeground="Gray"
                                        FontWeight="Bold"
                                        UnderlineColor="{DynamicResource SukiPrimaryColor}"/>
                                </Border>

                                <Separator Background="{DynamicResource SukiControlBorderBrush}" Height="1"/>

                                <!-- Translation Result -->
                                <Grid RowDefinitions="Auto,*">
                                    <StackPanel Orientation="Horizontal" Spacing="6" Margin="0,0,0,8">
                                        <icons:MaterialIcon Kind="Translate" Width="16" Height="16" Foreground="{DynamicResource SukiPrimaryColor}"/>
                                        <TextBlock Text="{x:Static lang:Resources.SelectionTranslate_ResultLabel}" FontWeight="SemiBold" FontSize="13" Foreground="{DynamicResource SukiText}"/>
                                    </StackPanel>
                                    <TextBlock x:Name="ResultTextBlock" Grid.Row="1" 
                                               Text="{Binding TranslationResult}" 
                                               TextWrapping="Wrap" FontSize="15" LineHeight="24"
                                               Foreground="{DynamicResource SukiText}"/>
                                </Grid>
                            </StackPanel>
                        </Border>
                    </Panel>
                </ScrollViewer>

                <!-- Footer Actions -->
                <Border Grid.Row="2" Background="{DynamicResource SukiCardBackground}" 
                        CornerRadius="0,0,12,12" Padding="12,8" BorderBrush="{DynamicResource SukiControlBorderBrush}" BorderThickness="0,1,0,0">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                         <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                             <Border Background="{DynamicResource SukiControlBorderBrush}" CornerRadius="4" Padding="6,2">
                                 <TextBlock Text="Auto Detect" FontSize="11" Foreground="{DynamicResource SukiText}"/>
                             </Border>
                             <icons:MaterialIcon Kind="ArrowRight" Width="14" Height="14" Foreground="{DynamicResource SukiText}"/>
                             <Border Background="{DynamicResource SukiControlBorderBrush}" CornerRadius="4" Padding="6,2">
                                 <TextBlock Text="{x:Static lang:Resources.SelectionTranslate_Language_Chinese}" FontSize="11" Foreground="{DynamicResource SukiText}"/>
                             </Border>
                         </StackPanel>

                        <!-- Removed History and Like buttons as requested -->
                        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                            <Button Click="OnCopyClick" ToolTip.Tip="{x:Static lang:Resources.SelectionTranslate_CopyTooltip}" 
                                    Classes="Flat" Padding="6" Width="32" Height="32">
                                <icons:MaterialIcon Kind="ContentCopy" Width="18" Height="18" Foreground="{DynamicResource SukiText}"/>
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>
        </suki:GlassCard>
    </Panel>
</Window>
