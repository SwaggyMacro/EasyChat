<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:EasyChat.ViewModels.Pages;assembly=EasyChat"
        xmlns:avalonia="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
        xmlns:converts="clr-namespace:EasyChat.Converters;assembly=EasyChat"
        xmlns:suki="https://github.com/kikipoulet/SukiUI"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="150"
        x:Class="EasyChat.Views.Speech.SubtitleOverlayWindow"
        x:DataType="vm:SpeechRecognitionViewModel"
        Title="SubtitleOverlayWindow"
        SystemDecorations="None"
        Background="Transparent"
        TransparencyLevelHint="Transparent"
        Topmost="True"
        ShowInTaskbar="False">

    <Window.Styles>
        <Style Selector="Button.ToolbarBtn">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="4"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.ToolbarBtn:hover">
            <Setter Property="Background" Value="#44888888"/>
        </Style>
    </Window.Styles>

    <!-- Root container that handles hit testing strategy -->
    <!-- Background is Transparent (HitTestVisible) when Unlocked, 
         and Null (Click-Through) when Locked. 
         But we need 'Unlock' button to be clickable, so we handle that by keeping the window HitTestVisible 
         but making the 'empty' areas null. -->
    
    <Grid Name="RootGrid" >
        
        <!-- Window Container (Background + Toolbar) -->
        <!-- Visible when: Unlocked AND (Hovering OR Dragging) -->
        <!-- Actually, user said: "Mouse move to subtitle area -> show". -->
        <Border x:Name="MainBorder" 
                Background="{Binding BackgroundColor}"
                CornerRadius="8"
                Padding="10"
                Opacity="{Binding WindowOpacity}">
            
            <Border.Styles>
                <Style Selector="Border#MainBorder">
                    <Setter Property="IsVisible" Value="True"/> 
                </Style>
                <!-- If Locked, Hide the Main Background container clearly -->
                <Style Selector="Border#MainBorder[Tag=True]"> <!-- Tag bound to IsLocked -->
                    <Setter Property="IsVisible" Value="False"/>
                </Style>
                
                <!-- Hover Effect when Unlocked -->
                <!-- Ideally default opacity is 0 or low, and 1 on hover. -->
                <!-- But user configures 'WindowOpacity'. Let's assume that's the 'active' opacity. -->
                <!-- When NOT hovering, maybe hide it? -->
                <!-- User: "You think it should only show when mouse moves to subtitle area" -->
                
                <Style Selector="Grid:not(:pointerover) Border#BackgroundBorder">
                     <Setter Property="IsVisible" Value="False"/>
                </Style>
                
                <!-- Exception: If we are resizing/dragging, keep it visible? Hard to track in pure XAML. -->
                <!-- Simplification: Show on Hover. -->
            </Border.Styles>
            
            <!-- Bind Tag to IsLocked for style trigger -->
            <Border.Tag>
                <Binding Path="IsFloatingWindowLocked"/>
            </Border.Tag>
        </Border>

        <!-- 2. Subtitles Layer -->
        <!-- Added Top Margin to avoid overlapping the Toolbar area initially -->
        <ScrollViewer VerticalScrollBarVisibility="Hidden" 
                      HorizontalScrollBarVisibility="Disabled" 
                      Margin="10,40,10,10"
                      IsHitTestVisible="{Binding !IsFloatingWindowLocked}">

            <ItemsControl ItemsSource="{Binding FloatingSubtitles}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <!-- Subtitle Background Pill -->
                        <Border Background="{Binding $parent[Window].((vm:SpeechRecognitionViewModel)DataContext).SubtitleBackgroundColor}"
                                CornerRadius="4"
                                Padding="8,4"
                                Margin="0,2">
                            <StackPanel>
                                <!-- Primary Subtitle -->
                                <Grid ColumnDefinitions="*, Auto">
                                    <TextBlock Grid.Column="0" 
                                               FontFamily="{Binding $parent[Window].((vm:SpeechRecognitionViewModel)DataContext).PrimaryFontFamily}"
                                               FontSize="{Binding $parent[Window].((vm:SpeechRecognitionViewModel)DataContext).PrimaryFontSize}"
                                               Foreground="{Binding $parent[Window].((vm:SpeechRecognitionViewModel)DataContext).PrimaryFontColor}"
                                               TextWrapping="Wrap"
                                               VerticalAlignment="Center">
                                        <TextBlock.Text>
                                            <MultiBinding Converter="{x:Static converts:SubtitleContentConverter.Instance}" ConverterParameter="Main">
                                                <Binding Path="OriginalText" />
                                                <Binding Path="TranslatedText" />
                                                <Binding Path="$parent[Window].((vm:SpeechRecognitionViewModel)DataContext).MainSubtitleSource" />
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                    <suki:Loading Grid.Column="1" Width="14" Height="14" VerticalAlignment="Center" Margin="6,0,0,0">
                                        <suki:Loading.IsVisible>
                                            <MultiBinding Converter="{x:Static converts:SubtitleLoadingConverter.Instance}" ConverterParameter="Main">
                                                <Binding Path="IsTranslating" />
                                                <Binding Path="$parent[Window].((vm:SpeechRecognitionViewModel)DataContext).MainSubtitleSource" />
                                            </MultiBinding>
                                        </suki:Loading.IsVisible>
                                    </suki:Loading>
                                </Grid>
                                
                                <!-- Secondary Subtitle -->
                                <Grid ColumnDefinitions="*, Auto" Margin="0,2,0,0">
                                    <Grid.IsVisible>
                                        <MultiBinding Converter="{x:Static converts:SubtitleVisibilityConverter.Instance}" ConverterParameter="Secondary">
                                            <Binding Path="OriginalText" />
                                            <Binding Path="TranslatedText" />
                                            <Binding Path="$parent[Window].((vm:SpeechRecognitionViewModel)DataContext).SecondarySubtitleSource" />
                                        </MultiBinding>
                                    </Grid.IsVisible>
                                    
                                    <TextBlock Grid.Column="0"
                                               FontFamily="{Binding $parent[Window].((vm:SpeechRecognitionViewModel)DataContext).SecondaryFontFamily}"
                                               FontSize="{Binding $parent[Window].((vm:SpeechRecognitionViewModel)DataContext).SecondaryFontSize}"
                                               Foreground="{Binding $parent[Window].((vm:SpeechRecognitionViewModel)DataContext).SecondaryFontColor}"
                                               TextWrapping="Wrap" 
                                               Opacity="0.8"
                                               VerticalAlignment="Center">
                                        <TextBlock.Text>
                                            <MultiBinding Converter="{x:Static converts:SubtitleContentConverter.Instance}" ConverterParameter="Secondary">
                                                <Binding Path="OriginalText" />
                                                <Binding Path="TranslatedText" />
                                                <Binding Path="$parent[Window].((vm:SpeechRecognitionViewModel)DataContext).SecondarySubtitleSource" />
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                    
                                    <suki:Loading Grid.Column="1" Width="12" Height="12" VerticalAlignment="Center" Margin="6,0,0,0">
                                        <suki:Loading.IsVisible>
                                            <MultiBinding Converter="{x:Static converts:SubtitleLoadingConverter.Instance}" ConverterParameter="Secondary">
                                                <Binding Path="IsTranslating" />
                                                <Binding Path="$parent[Window].((vm:SpeechRecognitionViewModel)DataContext).SecondarySubtitleSource" />
                                            </MultiBinding>
                                        </suki:Loading.IsVisible>
                                    </suki:Loading>
                                </Grid>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- 3. Toolbar Layer (Top Z-Index) -->
        <Border x:Name="Toolbar" 
                Background="#22FFFFFF" 
                CornerRadius="4" 
                Margin="10,10,10,0"
                Height="26"
                VerticalAlignment="Top"
                IsVisible="{Binding !IsFloatingWindowLocked}">
            
             <Border.Styles>
                <!-- Apply same Smart Visibility to Toolbar -->
                <Style Selector="Grid:not(:pointerover) Border#Toolbar">
                     <Setter Property="IsVisible" Value="False"/>
                </Style>
            </Border.Styles>
            
            <Grid ColumnDefinitions="Auto, *, Auto"> 
                <StackPanel Orientation="Horizontal" Spacing="2">
                    <avalonia:MaterialIcon Kind="Drag" Width="16" Height="16" Opacity="0.5" VerticalAlignment="Center" Margin="5,0"/>
                </StackPanel>
                
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="2">
                    <Button Command="{Binding IncreaseFontSizeCommand}" Classes="ToolbarBtn" ToolTip.Tip="Increase Font Size">
                        <TextBlock Text="A+" Foreground="White" FontWeight="Bold" FontSize="13" VerticalAlignment="Center"/>
                    </Button>
                    <Button Command="{Binding DecreaseFontSizeCommand}" Classes="ToolbarBtn" ToolTip.Tip="Decrease Font Size">
                        <TextBlock Text="A-" Foreground="White" FontWeight="Bold" FontSize="13" VerticalAlignment="Center"/>
                    </Button>
                     <Button Command="{Binding ToggleLockCommand}" Classes="ToolbarBtn" ToolTip.Tip="Lock Window">
                        <avalonia:MaterialIcon Kind="LockOpen" Width="16" Height="16" Foreground="White"/>
                    </Button>
                    <Button Click="CloseButton_Click" Classes="ToolbarBtn" ToolTip.Tip="Close Floating Window">
                        <avalonia:MaterialIcon Kind="Close" Width="16" Height="16" Foreground="White"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Unlock Button (Floating, Visible ONLY when Locked) -->
        <Button x:Name="UnlockBtn"
                Command="{Binding ToggleLockCommand}" 
                Classes="ToolbarBtn" 
                IsVisible="{Binding IsFloatingWindowLocked}"
                HorizontalAlignment="Right" VerticalAlignment="Top"
                Margin="5"
                ToolTip.Tip="Unlock Window">
             <avalonia:MaterialIcon Kind="Lock" Width="16" Height="16" Foreground="White" Opacity="0.5"/>
        </Button>

        <!-- Resize Grip -->
         <avalonia:MaterialIcon Kind="ResizeBottomRight" 
                               Width="24" Height="24" 
                               Foreground="White"
                               Opacity="0.8"
                               VerticalAlignment="Bottom"
                               HorizontalAlignment="Right"
                               Cursor="BottomRightCorner"
                               PointerPressed="OnResizePointerPressed">
             <avalonia:MaterialIcon.IsVisible>
                 <MultiBinding Converter="{x:Static BoolConverters.And}">
                     <Binding Path="!IsFloatingWindowLocked"/>
                     <Binding Path="#RootGrid.IsPointerOver"/> <!-- Only show resize grip on hover too? -->
                 </MultiBinding>
             </avalonia:MaterialIcon.IsVisible>
         </avalonia:MaterialIcon>
    </Grid>
</Window>
